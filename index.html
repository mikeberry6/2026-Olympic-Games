<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="description" content="Milan 2026 Olympic Fantasy Market - Build your medal portfolio">
  <meta name="theme-color" content="#0a0e1a">
  <title>Milan 2026 Fantasy Market</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Snowfall Animation Container -->
  <div class="snowfall" id="snowfall"></div>

  <!-- ============================================ -->
  <!-- DASHBOARD                                     -->
  <!-- ============================================ -->
  <section id="dashboard-view" class="view">
    <div class="container">
      <header class="dashboard-header">
        <div class="header-top">
          <div class="header-brand">
            <div class="olympic-rings small">‚óè‚óè‚óè‚óè‚óè</div>
            <h1 class="logo"><span class="city">Milano Cortina</span><span class="year">2026</span></h1>
          </div>
          <div class="total-medals">
            <div class="medal-trophy">üèÜ</div>
            <span class="medal-count" id="total-medal-count">0</span>
            <span class="medal-label">Total Points</span>
          </div>
        </div>
      </header>

      <!-- Leaderboard Section -->
      <section class="leaderboard-section">
        <h2 class="section-title">üèÖ Leaderboard</h2>
        <div id="leaderboard-cards" class="leaderboard-cards">
          <!-- Populated by JS -->
        </div>
      </section>

      <!-- Commissioner Commentary -->
      <section class="commentary-section" id="commentary-section">
        <h2 class="section-title">üì∞ Commissioner's Commentary</h2>
        <div id="commentary-card" class="commentary-card glass-card">
          <p class="empty-state" id="commentary-text">No commentary yet. The Commissioner is sharpening his quill...</p>
        </div>
      </section>

      <!-- Portfolio Details Section -->
      <section class="portfolios-section">
        <h2 class="section-title">üìä Team Portfolios</h2>
        <div id="portfolio-grid" class="portfolio-grid">
          <!-- Populated by JS -->
        </div>
      </section>
    </div>

    <!-- Footer with Admin Access -->
    <footer class="app-footer">
      <div class="footer-info">
        <span class="version">v6.0 Milano Edition</span>
        <span class="last-updated" id="last-updated"></span>
      </div>
      <button id="admin-key-btn" class="admin-key-btn" aria-label="Admin access">
        üîë
      </button>
    </footer>
  </section>

  <!-- ============================================ -->
  <!-- VIEW E: ADMIN CONSOLE (Modal)               -->
  <!-- ============================================ -->
  <div id="admin-modal" class="modal hidden" role="dialog" aria-labelledby="admin-title" aria-modal="true">
    <div class="modal-backdrop" id="modal-backdrop"></div>
    <div class="modal-content">
      <header class="modal-header">
        <h2 id="admin-title" class="modal-title">üîê Commissioner Reif-Wray's Console</h2>
        <button id="close-modal-btn" class="close-btn" aria-label="Close">&times;</button>
      </header>

      <div class="modal-body">
        <!-- Session Banner -->
        <div id="session-banner" class="session-banner hidden">
          <div class="session-banner-info">
            <span class="session-banner-icon">üìù</span>
            <span class="session-banner-text" id="session-banner-text">0 medals added this session</span>
          </div>
          <button id="publish-update-btn" class="btn btn-primary btn-publish">Publish Daily Update</button>
        </div>

        <!-- Add Medal Section -->
        <section class="admin-section">
          <h3 class="admin-section-title">üèÖ Record Medal</h3>

          <div class="form-group">
            <label for="country-select">Select Country</label>
            <select id="country-select" class="form-select">
              <option value="">-- Select country --</option>
              <!-- Populated by JS -->
            </select>
          </div>

          <div class="form-group">
            <label for="event-input">Event Description</label>
            <input type="text" id="event-input" class="form-input" placeholder="e.g., Men's Downhill Alpine Skiing" list="event-suggestions" autocomplete="off">
            <datalist id="event-suggestions"></datalist>
          </div>

          <div class="form-group">
            <label>Medal Type</label>
            <div class="medal-buttons">
              <button type="button" class="medal-btn gold" data-medal="gold">ü•á Gold (+3)</button>
              <button type="button" class="medal-btn silver" data-medal="silver">ü•à Silver (+2)</button>
              <button type="button" class="medal-btn bronze" data-medal="bronze">ü•â Bronze (+1)</button>
            </div>
          </div>

          <button id="add-medal-btn" class="btn btn-primary" disabled>Record Medal</button>
        </section>

        <!-- Transaction Log Section -->
        <section class="admin-section">
          <h3 class="admin-section-title">üìú Medal Log</h3>
          <div id="transaction-log" class="transaction-log">
            <p class="empty-state">No medals recorded yet</p>
          </div>
        </section>

        <!-- Commissioner Commentary Section -->
        <section class="admin-section">
          <h3 class="admin-section-title">üì∞ Commissioner's Commentary</h3>
          <div class="form-group">
            <label for="commentary-input">Write your daily dispatch</label>
            <textarea id="commentary-input" class="form-input commentary-textarea" rows="3" placeholder="e.g., The Norwegian Empire marches on! But watch out for the Swiss..."></textarea>
          </div>
          <button id="save-commentary-btn" class="btn btn-primary">Publish Commentary</button>
        </section>

        <!-- Data Management Section -->
        <section class="admin-section">
          <h3 class="admin-section-title">‚öôÔ∏è League Management</h3>
          <div class="data-actions">
            <button id="export-btn" class="btn btn-secondary">üìã Export</button>
            <button id="import-btn" class="btn btn-secondary">üì• Import</button>
          </div>
          <button id="reset-btn" class="btn btn-danger">üóëÔ∏è Reset League</button>
        </section>
      </div>
    </div>
  </div>

  <!-- Medal Celebration Overlay -->
  <div id="celebration-overlay" class="celebration-overlay hidden" aria-hidden="true">
    <canvas id="confetti-canvas"></canvas>
    <div class="celebration-content">
      <div class="celebration-medal" id="celebration-medal"></div>
      <div class="celebration-text" id="celebration-text"></div>
      <div class="celebration-event" id="celebration-event"></div>
    </div>
  </div>

  <!-- Breaking News Ticker -->
  <div id="news-ticker" class="news-ticker hidden">
    <div class="ticker-label">DAILY RECAP</div>
    <div class="ticker-text" id="ticker-text"></div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast hidden" role="alert" aria-live="polite"></div>

  <!-- ============================================ -->
  <!-- STYLES                                       -->
  <!-- ============================================ -->
  <style>
    /* ========================================
       1. CSS VARIABLES - Milano Cortina 2026 Theme
       ======================================== */
    :root {
      /* Milano Cortina 2026 Inspired Colors */
      --bg-depth: #0a0e1a;
      --bg-surface: #141c2f;
      --bg-elevated: #1a2440;
      --glass-border: 1px solid rgba(255, 255, 255, 0.1);
      --glass-bg: rgba(20, 28, 47, 0.8);

      /* Italian Flag + Olympic Colors */
      --italian-green: #008C45;
      --italian-red: #CD212A;
      --olympic-blue: #0081C8;
      --olympic-yellow: #FCB131;
      --olympic-green: #00A651;
      --olympic-red: #EE334E;

      /* Tier Colors */
      --blue-chip: #4FC3F7;
      --mid-cap: #81C784;
      --penny-stock: #FFB74D;

      /* Primary Accent */
      --accent-primary: #00D4FF;
      --accent-gold: #FFD700;

      --text-primary: #FFFFFF;
      --text-secondary: #B8C5D6;
      --text-muted: #7A8BA3;

      /* Medal Colors */
      --gold: #FFD700;
      --silver: #C0C0C0;
      --bronze: #CD7F32;

      /* Semantic */
      --success: #00E676;
      --warning: #FFAB00;
      --danger: #FF5252;

      /* Typography */
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;

      /* Spacing */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
      --space-2xl: 48px;

      /* Border Radius */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;

      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-normal: 300ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ========================================
       2. RESET & BASE
       ======================================== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
    }

    body {
      font-family: var(--font-family);
      background: var(--bg-depth);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* Animated Background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse at 20% 20%, rgba(0, 140, 69, 0.12) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 20%, rgba(0, 129, 200, 0.12) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 80%, rgba(205, 33, 42, 0.08) 0%, transparent 50%);
      animation: gradientShift 25s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes gradientShift {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Snowfall */
    .snowfall {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
      overflow: hidden;
    }

    .snowflake {
      position: absolute;
      top: -20px;
      color: rgba(255, 255, 255, 0.5);
      animation: fall linear infinite;
    }

    @keyframes fall {
      to { transform: translateY(105vh) rotate(360deg); }
    }

    /* ========================================
       3. LAYOUT
       ======================================== */
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--space-md);
      position: relative;
      z-index: 2;
    }

    .view {
      min-height: 100vh;
      padding-bottom: 100px;
    }

    .hidden { display: none !important; }

    /* ========================================
       4. TYPOGRAPHY
       ======================================== */
    .logo {
      font-size: 1.75rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      text-transform: uppercase;
    }

    .logo.small { font-size: 1.25rem; }

    .logo .city {
      background: linear-gradient(135deg, var(--italian-green), var(--olympic-blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .logo .year {
      background: linear-gradient(135deg, var(--olympic-yellow), var(--italian-red));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-left: 0.25em;
    }

    .olympic-rings {
      font-size: 1.25rem;
      letter-spacing: 0.15em;
      background: linear-gradient(90deg, #0081C8, #000, #EE334E, #FCB131, #00A651);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: var(--space-xs);
    }

    .olympic-rings.small { font-size: 0.75rem; }

    .section-title {
      font-size: 0.875rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--accent-primary);
      margin-bottom: var(--space-md);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .section-title::before {
      content: '';
      width: 4px;
      height: 1em;
      background: linear-gradient(180deg, var(--italian-green), var(--italian-red));
      border-radius: 2px;
    }

    /* ========================================
       5. GLASS CARD
       ======================================== */
    .glass-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: var(--glass-border);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
    }

    /* ========================================
       6. BUTTONS
       ======================================== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      font-family: inherit;
      font-size: 0.9375rem;
      font-weight: 600;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-normal);
      min-height: 48px;
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--italian-green), var(--olympic-blue));
      color: #fff;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 140, 69, 0.4);
      background: linear-gradient(135deg, var(--italian-green), var(--italian-red));
    }

    .btn-secondary {
      background: var(--bg-surface);
      color: var(--text-primary);
      border: var(--glass-border);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--bg-elevated);
    }

    .btn-warning {
      background: linear-gradient(135deg, var(--warning), var(--olympic-yellow));
      color: #000;
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger), var(--italian-red));
      color: #fff;
    }

    .btn-large {
      width: 100%;
      padding: var(--space-md) var(--space-lg);
      font-size: 1.0625rem;
      min-height: 56px;
      border-radius: var(--radius-lg);
    }

    /* ========================================
       7. FORMS
       ======================================== */
    .form-group {
      margin-bottom: var(--space-md);
    }

    .form-group label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: var(--space-xs);
    }

    .form-select, .form-input {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      font-family: inherit;
      font-size: 1rem;
      color: var(--text-primary);
      background: var(--bg-surface);
      border: var(--glass-border);
      border-radius: var(--radius-md);
      min-height: 48px;
    }

    .form-select:focus, .form-input:focus {
      outline: none;
      border-color: var(--accent-primary);
    }

    /* ========================================
       8. VIEW D - DASHBOARD
       ======================================== */
    .dashboard-header {
      padding: var(--space-xl) 0 var(--space-lg);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-md);
    }

    .header-brand {
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .total-medals {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05));
      padding: var(--space-md) var(--space-lg);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 215, 0, 0.2);
    }

    .medal-trophy {
      font-size: 1.5rem;
      animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    .total-medals .medal-count {
      font-size: 2rem;
      font-weight: 800;
      color: var(--accent-gold);
      font-feature-settings: "tnum";
    }

    .total-medals .medal-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    /* Leaderboard */
    .leaderboard-section {
      margin-bottom: var(--space-xl);
    }

    .leaderboard-cards {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .leaderboard-card {
      background: var(--glass-bg);
      border: var(--glass-border);
      border-radius: var(--radius-lg);
      padding: var(--space-md);
      display: flex;
      align-items: center;
      gap: var(--space-md);
      transition: all var(--transition-normal);
      position: relative;
      overflow: hidden;
    }

    .leaderboard-card::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--italian-green), white, var(--italian-red));
      opacity: 0.5;
    }

    .leaderboard-card.rank-1 {
      border-color: rgba(255, 215, 0, 0.4);
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.12), var(--glass-bg));
      animation: goldGlow 3s ease-in-out infinite;
    }

    @keyframes goldGlow {
      0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.15); }
      50% { box-shadow: 0 0 35px rgba(255, 215, 0, 0.25); }
    }

    .leaderboard-card.rank-2 {
      border-color: rgba(192, 192, 192, 0.3);
      background: linear-gradient(135deg, rgba(192, 192, 192, 0.08), var(--glass-bg));
    }

    .leaderboard-card.rank-3 {
      border-color: rgba(205, 127, 50, 0.3);
      background: linear-gradient(135deg, rgba(205, 127, 50, 0.08), var(--glass-bg));
    }

    .rank-badge {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-md);
      background: var(--bg-surface);
      font-size: 1.25rem;
      font-weight: 800;
      flex-shrink: 0;
    }

    .rank-1 .rank-badge {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.1));
      color: var(--gold);
    }

    .rank-2 .rank-badge {
      background: linear-gradient(135deg, rgba(192, 192, 192, 0.2), rgba(192, 192, 192, 0.05));
      color: var(--silver);
    }

    .rank-3 .rank-badge {
      background: linear-gradient(135deg, rgba(205, 127, 50, 0.2), rgba(205, 127, 50, 0.05));
      color: var(--bronze);
    }

    .card-info {
      flex: 1;
      min-width: 0;
    }

    .card-team-name {
      font-weight: 700;
      font-size: 1rem;
    }

    .card-portfolio-summary {
      font-size: 0.75rem;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-stats {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      flex-shrink: 0;
    }

    .card-medals {
      display: flex;
      gap: var(--space-xs);
      font-size: 0.8125rem;
    }

    .card-points {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--accent-gold);
      font-feature-settings: "tnum";
    }

    /* Portfolio Grid */
    .portfolios-section {
      padding-bottom: var(--space-xl);
    }

    .portfolio-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-md);
    }

    .portfolio-card {
      background: var(--glass-bg);
      border: var(--glass-border);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .portfolio-card::before {
      content: '';
      display: block;
      height: 4px;
      background: linear-gradient(90deg, var(--olympic-blue), var(--olympic-yellow), var(--olympic-green), var(--olympic-red));
    }

    .portfolio-card-header {
      padding: var(--space-md);
      border-bottom: var(--glass-border);
    }

    .portfolio-team-name {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 2px;
    }

    .portfolio-stats {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .portfolio-card-body {
      padding: var(--space-md);
    }

    .portfolio-country {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-sm) 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .portfolio-country:last-child { border-bottom: none; }

    .portfolio-country-info {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .portfolio-country-flag {
      font-size: 1.25rem;
    }

    .portfolio-country-name {
      font-size: 0.875rem;
    }

    .portfolio-country-medals {
      display: flex;
      gap: var(--space-xs);
      font-size: 0.75rem;
    }

    .portfolio-country-points {
      font-weight: 700;
      color: var(--accent-gold);
      min-width: 30px;
      text-align: right;
    }

    /* ========================================
       12. FOOTER
       ======================================== */
    .app-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: var(--space-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
      pointer-events: none;
      z-index: 100;
    }

    .footer-info {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      font-size: 0.75rem;
      color: var(--text-muted);
      pointer-events: all;
    }

    .admin-key-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--bg-surface);
      border: var(--glass-border);
      cursor: pointer;
      font-size: 1.125rem;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: all;
      opacity: 0.6;
      transition: all var(--transition-fast);
    }

    .admin-key-btn:hover {
      opacity: 1;
      background: var(--bg-elevated);
    }

    /* ========================================
       13. MODAL
       ======================================== */
    .modal {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }

    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
    }

    .modal-content {
      position: relative;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      background: var(--bg-surface);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-md) var(--space-lg);
      border-bottom: var(--glass-border);
    }

    .modal-title {
      font-size: 1.125rem;
      font-weight: 700;
    }

    .close-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      border-radius: var(--radius-sm);
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    .modal-body {
      padding: var(--space-lg);
      overflow-y: auto;
      flex: 1;
    }

    .admin-section {
      margin-bottom: var(--space-xl);
    }

    .admin-section:last-child { margin-bottom: 0; }

    .admin-section-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-md);
    }

    .medal-buttons {
      display: flex;
      gap: var(--space-sm);
    }

    .medal-btn {
      flex: 1;
      padding: var(--space-sm);
      font-family: inherit;
      font-size: 0.8125rem;
      font-weight: 600;
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      background: var(--bg-depth);
      color: var(--text-secondary);
      min-height: 44px;
      transition: all var(--transition-fast);
    }

    .medal-btn.selected {
      border-color: currentColor;
    }

    .medal-btn.gold.selected { color: var(--gold); background: rgba(255, 215, 0, 0.1); }
    .medal-btn.silver.selected { color: var(--silver); background: rgba(192, 192, 192, 0.1); }
    .medal-btn.bronze.selected { color: var(--bronze); background: rgba(205, 127, 50, 0.1); }

    .transaction-log {
      max-height: 200px;
      overflow-y: auto;
      background: var(--bg-depth);
      border-radius: var(--radius-md);
      padding: var(--space-sm);
    }

    .transaction-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-sm);
      border-radius: var(--radius-sm);
    }

    .transaction-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .transaction-info { flex: 1; }

    .transaction-main {
      font-size: 0.875rem;
    }

    .transaction-time {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .transaction-delete {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: var(--radius-sm);
    }

    .transaction-delete:hover {
      background: rgba(255, 68, 68, 0.2);
      color: var(--danger);
    }

    .data-actions {
      display: flex;
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
    }

    .data-actions .btn { flex: 1; }

    #reopen-market-btn { width: 100%; margin-bottom: var(--space-sm); }
    #reset-btn { width: 100%; }

    .empty-state {
      color: var(--text-muted);
      font-style: italic;
      text-align: center;
      padding: var(--space-md);
    }

    /* ========================================
       14. TOAST
       ======================================== */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-surface);
      border: var(--glass-border);
      border-radius: var(--radius-md);
      padding: var(--space-sm) var(--space-lg);
      font-size: 0.875rem;
      z-index: 1100;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    .toast.toast-success { border-color: var(--success); }
    .toast.toast-error { border-color: var(--danger); }

    /* ========================================
       15. REFRESH BUTTON & SECTION TITLE ROW
       ======================================== */
    /* ========================================
       18. COUNTRY LINK IN PORTFOLIO
       ======================================== */
    .portfolio-country-link {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      text-decoration: none;
      color: inherit;
      transition: color var(--transition-fast);
    }

    .portfolio-country-link:hover {
      color: var(--accent-primary);
    }

    .portfolio-country-link:hover .portfolio-country-name {
      text-decoration: underline;
    }

    /* ========================================
       20. SESSION BANNER
       ======================================== */
    .session-banner {
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.12), rgba(0, 140, 69, 0.08));
      border: 1px solid rgba(0, 212, 255, 0.25);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-bottom: var(--space-lg);
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .session-banner.hidden { display: none !important; }

    .session-banner-info {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .session-banner-icon {
      font-size: 1.25rem;
    }

    .session-banner-text {
      font-weight: 700;
      color: var(--accent-primary);
      font-size: 0.9375rem;
    }

    .btn-publish {
      width: 100%;
      min-height: 48px;
      font-size: 1rem;
      background: linear-gradient(135deg, var(--accent-gold), #FFA500);
      color: #000;
    }

    .btn-publish:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
    }

    /* Inline medal confirmation (replaces confirm dialog) */
    .medal-added-flash {
      background: rgba(0, 230, 118, 0.15);
      border: 1px solid rgba(0, 230, 118, 0.3);
      border-radius: var(--radius-md);
      padding: var(--space-sm) var(--space-md);
      margin-bottom: var(--space-md);
      font-size: 0.875rem;
      color: var(--success);
      font-weight: 600;
      animation: flashIn 0.3s ease;
    }

    @keyframes flashIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ========================================
       21. MEDAL CELEBRATION OVERLAY
       ======================================== */
    .celebration-overlay {
      position: fixed;
      inset: 0;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.85);
      animation: celebrationFadeIn 0.3s ease;
    }

    .celebration-overlay.hidden {
      display: none !important;
    }

    @keyframes celebrationFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    #confetti-canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .celebration-content {
      position: relative;
      z-index: 1;
      text-align: center;
      animation: celebrationPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes celebrationPop {
      0% { transform: scale(0.3); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    .celebration-medal {
      font-size: 6rem;
      margin-bottom: var(--space-md);
      animation: celebrationBounce 0.6s ease infinite alternate;
    }

    @keyframes celebrationBounce {
      from { transform: translateY(0); }
      to { transform: translateY(-15px); }
    }

    .celebration-text {
      font-size: 1.75rem;
      font-weight: 800;
      margin-bottom: var(--space-sm);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .celebration-text.gold-text {
      background: linear-gradient(135deg, #FFD700, #FFA500, #FFD700);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .celebration-text.silver-text {
      background: linear-gradient(135deg, #C0C0C0, #E8E8E8, #C0C0C0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .celebration-text.bronze-text {
      background: linear-gradient(135deg, #CD7F32, #E8A850, #CD7F32);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .celebration-event {
      font-size: 1.125rem;
      color: var(--text-secondary);
      max-width: 400px;
      margin: 0 auto;
    }

    /* ========================================
       21. BREAKING NEWS TICKER
       ======================================== */
    .news-ticker {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1500;
      display: flex;
      align-items: center;
      background: linear-gradient(90deg, #0a1628, #141c2f);
      color: #fff;
      font-weight: 700;
      overflow: hidden;
      height: 44px;
      border-bottom: 2px solid var(--accent-gold);
      animation: tickerSlideDown 0.4s ease;
    }

    .news-ticker.hidden {
      display: none !important;
    }

    @keyframes tickerSlideDown {
      from { transform: translateY(-100%); }
      to { transform: translateY(0); }
    }

    .ticker-label {
      background: linear-gradient(135deg, var(--accent-gold), #FFA500);
      color: #000;
      padding: 0 var(--space-md);
      font-size: 0.6875rem;
      font-weight: 800;
      letter-spacing: 0.1em;
      height: 100%;
      display: flex;
      align-items: center;
      flex-shrink: 0;
    }

    .ticker-text {
      white-space: nowrap;
      padding: 0 var(--space-lg);
      font-size: 0.875rem;
      animation: tickerScroll 15s linear;
    }

    @keyframes tickerScroll {
      0% { transform: translateX(100vw); }
      100% { transform: translateX(0); }
    }

    /* ========================================
       23. COMMISSIONER COMMENTARY
       ======================================== */
    .commentary-section {
      margin-bottom: var(--space-xl);
    }

    .commentary-card {
      position: relative;
      overflow: hidden;
    }

    .commentary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-gold), var(--olympic-yellow));
    }

    .commentary-card .commentary-body {
      font-size: 1.0625rem;
      line-height: 1.7;
      color: var(--text-secondary);
      font-style: italic;
    }

    .commentary-card .commentary-sig {
      margin-top: var(--space-md);
      font-size: 0.8125rem;
      color: var(--text-muted);
      font-style: normal;
      text-align: right;
    }

    .commentary-textarea {
      resize: vertical;
      min-height: 80px;
      line-height: 1.5;
    }

    /* ========================================
       25. RESPONSIVE
       ======================================== */
    @media (max-width: 767px) {
      .modal-content {
        max-height: 95vh;
      }

      .modal-body {
        padding: var(--space-md);
      }

      .medal-buttons {
        flex-direction: column;
      }

      .medal-btn {
        min-height: 48px;
      }

      .card-medals {
        flex-direction: column;
        gap: 0;
        font-size: 0.6875rem;
        text-align: right;
      }

      .celebration-medal {
        font-size: 4rem;
      }

      .celebration-text {
        font-size: 1.25rem;
      }

      .celebration-event {
        font-size: 0.9375rem;
      }
    }

    @media (min-width: 768px) {
      .container { padding: var(--space-lg); }

      .portfolio-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .modal {
        align-items: center;
      }

      .modal-content {
        border-radius: var(--radius-lg);
        max-height: 80vh;
      }
    }

    @media (min-width: 1024px) {
      .portfolio-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
  </style>

  <!-- ============================================ -->
  <!-- JAVASCRIPT                                   -->
  <!-- ============================================ -->
  <script>
    /* ========================================
       1. CONSTANTS
       ======================================== */

    const PARTICIPANTS = [
      { id: 1, name: 'Mike & Allegra Berry' },
      { id: 2, name: 'Christopher & Rebecca Wray' },
      { id: 3, name: 'Stephen & Rhandi Zipp' },
      { id: 4, name: 'Ryan & Haley Baskerville' },
      { id: 5, name: 'Maddi & Preston Lakey' },
      { id: 6, name: 'Jaynen & Britt Rissling' },
      { id: 7, name: 'Kieran & Zoe Armstrong' }
    ];

    const COUNTRIES = {
      // BLUE CHIPS ($26-40) ‚Äî 25+ medals projected
      'nor': {
        id: 'nor', name: 'Norway', flag: 'üá≥üá¥', price: 40, tier: 'blue-chip',
        projection: '~40 medals, ~17 golds',
        description: 'The undisputed king of winter. Kl√¶bo in XC, dominant Biathlon squad, and Russia\'s ban redistributes medals their way.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/nor'
      },
      'usa': {
        id: 'usa', name: 'USA', flag: 'üá∫üá∏', price: 32, tier: 'blue-chip',
        projection: '~32 medals, ~12 golds',
        description: 'NHL players return. Jordan Stolz dominates speed skating, Shiffrin seeks alpine redemption. Huge freestyle/snowboard depth.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/usa'
      },
      'ger': {
        id: 'ger', name: 'Germany', flag: 'üá©üá™', price: 29, tier: 'blue-chip',
        projection: '~29 medals, ~11 golds',
        description: 'The sliding sports monopoly. Luge, Bobsled, Skeleton fortress on the Cortina track. Strong Biathlon and Ski Jumping.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/ger'
      },
      'can': {
        id: 'can', name: 'Canada', flag: 'üá®üá¶', price: 26, tier: 'blue-chip',
        projection: '~26 medals, ~8 golds',
        description: 'Crosby and McDavid finally team up. Men\'s Hockey is a "double gold" swing with the Women. Strong Freestyle and Short Track.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/can'
      },

      // MID-CAPS ($9-20) ‚Äî 9-20 medals projected
      'aut': {
        id: 'aut', name: 'Austria', flag: 'üá¶üáπ', price: 20, tier: 'mid-cap',
        projection: '~20 medals, ~7 golds',
        description: 'Alpine skiing royalty. Bormio slopes built for their technical squad. Plus Ski Jumping, Nordic Combined, and Luge.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/aut'
      },
      'swe': {
        id: 'swe', name: 'Sweden', flag: 'üá∏üá™', price: 19, tier: 'mid-cap',
        projection: '~19 medals, ~7 golds',
        description: 'The quiet achiever. Cross-country skiing depth, Biathlon relays, Curling, and NHL-boosted Hockey.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/swe'
      },
      'ita': {
        id: 'ita', name: 'Italy', flag: 'üáÆüáπ', price: 18, tier: 'mid-cap',
        projection: '~18 medals, ~5 golds (Host)',
        description: 'The Host Bump. Home-field advantage for Goggia and Brignone in alpine. New Ski Mountaineering events favor Italy heavily.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/ita'
      },
      'sui': {
        id: 'sui', name: 'Switzerland', flag: 'üá®üá≠', price: 17, tier: 'mid-cap',
        projection: '~17 medals, ~6 golds',
        description: 'Marco Odermatt is the alpine GOAT-in-waiting. Ski Mountaineering, Snowboard Cross, and Bobsled add depth.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/sui'
      },
      'fra': {
        id: 'fra', name: 'France', flag: 'üá´üá∑', price: 16, tier: 'mid-cap',
        projection: '~16 medals, ~5 golds',
        description: 'Biathlon powerhouse plus alpine and freestyle upside. New Ski Mountaineering events are a boost.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/fra'
      },
      'ned': {
        id: 'ned', name: 'Netherlands', flag: 'üá≥üá±', price: 15, tier: 'mid-cap',
        projection: '~15 medals, ~6 golds',
        description: 'Speed Skating pure-play. Volatile: if the Milan oval is fast, they could return 20. Minimal diversification.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/ned'
      },
      'jpn': {
        id: 'jpn', name: 'Japan', flag: 'üáØüáµ', price: 14, tier: 'mid-cap',
        projection: '~14 medals, ~4 golds',
        description: 'Figure skating excellence, Ski Jumping depth, Speed Skating, and Halfpipe specialists. Consistent and technical.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/jpn'
      },
      'kor': {
        id: 'kor', name: 'South Korea', flag: 'üá∞üá∑', price: 10, tier: 'mid-cap',
        projection: '~10 medals, ~3 golds',
        description: 'Short Track factory. Upgraded from penny stock after dominant 2024-25 World Cup season. One crash or DQ still hurts.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/kor'
      },
      'chn': {
        id: 'chn', name: 'China', flag: 'üá®üá≥', price: 9, tier: 'mid-cap',
        projection: '~9 medals, ~3 golds',
        description: 'Post-host correction from 15 in Beijing. Still elite in Short Track and Freestyle Aerials. Eileen Gu factor.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/chn'
      },
      'fin': {
        id: 'fin', name: 'Finland', flag: 'üá´üáÆ', price: 9, tier: 'mid-cap',
        projection: '~9 medals, ~2 golds',
        description: 'NHL-boosted Men\'s Hockey, Cross-country skiing, and Ski Jumping. Solid floor with hockey upside.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/fin'
      },

      // PENNY STOCKS ($1-7) ‚Äî 1-7 medals projected
      'cze': {
        id: 'cze', name: 'Czech Republic', flag: 'üá®üáø', price: 7, tier: 'penny-stock',
        projection: '~7 medals, ~2 golds',
        description: 'Ester Ledeck√° is a dual-sport superstar (alpine + snowboard). Biathlon squad and NHL Hockey add upside.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/cze'
      },
      'svn': {
        id: 'svn', name: 'Slovenia', flag: 'üá∏üáÆ', price: 5, tier: 'penny-stock',
        projection: '~5 medals, ~2 golds',
        description: 'Ski Jumping powerhouse for their size. Alpine skiing and Cross-country add sneaky value.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/svn'
      },
      'gbr': {
        id: 'gbr', name: 'Great Britain', flag: 'üá¨üáß', price: 4, tier: 'penny-stock',
        projection: '~4 medals',
        description: 'Curling is the anchor. Skeleton pedigree plus Freestyle upside with Mia Brookes in snowboard.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/gbr'
      },
      'aus': {
        id: 'aus', name: 'Australia', flag: 'üá¶üá∫', price: 4, tier: 'penny-stock',
        projection: '~4 medals',
        description: 'Efficient. Jakara Anthony (Moguls) and strong Halfpipe squad are near-locks. Best bang for your buck?',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/aus'
      },
      'nzl': {
        id: 'nzl', name: 'New Zealand', flag: 'üá≥üáø', price: 2, tier: 'penny-stock',
        projection: '~2 medals',
        description: 'Zoi Sadowski-Synnott hunts Snowboard gold. Low volume, but elite upside in Slopestyle and Big Air.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/nzl'
      },
      'hun': {
        id: 'hun', name: 'Hungary', flag: 'üá≠üá∫', price: 2, tier: 'penny-stock',
        projection: '~2 medals',
        description: 'Short Track speed skating specialists. Liu brothers carry the hopes. Boom-or-bust lottery ticket.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/hun'
      },
      'pol': {
        id: 'pol', name: 'Poland', flag: 'üáµüá±', price: 2, tier: 'penny-stock',
        projection: '~2 medals',
        description: 'Ski Jumping squad and Cross-country dark horses. Cheap diversification play.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/pol'
      },
      'svk': {
        id: 'svk', name: 'Slovakia', flag: 'üá∏üá∞', price: 1, tier: 'penny-stock',
        projection: '~1 medal',
        description: 'Alpine skiing and Biathlon long shots. Petra Vlhov√°\'s comeback could pay off big.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/svk'
      },
      'bel': {
        id: 'bel', name: 'Belgium', flag: 'üáßüá™', price: 1, tier: 'penny-stock',
        projection: '~1 medal',
        description: 'Skeleton and Speed Skating dark horse. The ultimate deep-value contrarian pick.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/bel'
      },
      'est': {
        id: 'est', name: 'Estonia', flag: 'üá™üá™', price: 1, tier: 'penny-stock',
        projection: '~1 medal',
        description: 'Cross-country skiing specialists. Could surprise in Biathlon relays.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/est'
      },
      'lat': {
        id: 'lat', name: 'Latvia', flag: 'üá±üáª', price: 1, tier: 'penny-stock',
        projection: '~1 medal',
        description: 'Bobsled, Luge, and Skeleton contenders. The Baltic sliding factory.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/lat'
      },
      'esp': {
        id: 'esp', name: 'Spain', flag: 'üá™üá∏', price: 1, tier: 'penny-stock',
        projection: '~1 medal',
        description: 'New Ski Mountaineering events are Spain\'s golden ticket. A true wildcard.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/esp'
      },
      'den': {
        id: 'den', name: 'Denmark', flag: 'üá©üá∞', price: 1, tier: 'penny-stock',
        projection: '~1 medal',
        description: 'Curling and Speed Skating hopefuls. Low probability, but costs nothing.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/den'
      },
      'ukr': {
        id: 'ukr', name: 'Ukraine', flag: 'üá∫üá¶', price: 1, tier: 'penny-stock',
        projection: '~1 medal',
        description: 'Biathlon and Freestyle skiing contenders. Resilient program competing against the odds.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/ukr'
      },
      'kaz': {
        id: 'kaz', name: 'Kazakhstan', flag: 'üá∞üáø', price: 1, tier: 'penny-stock',
        projection: '~1 medal',
        description: 'Cross-country skiing and Freestyle dark horse. Central Asian wildcard at the minimum price.',
        olympicsUrl: 'https://olympics.com/en/olympic-games/milan-cortina-2026/countries/kaz'
      }
    };

    const MEDAL_POINTS = { gold: 3, silver: 2, bronze: 1 };
    const MEDAL_EMOJI = { gold: 'ü•á', silver: 'ü•à', bronze: 'ü•â' };
    const STORAGE_KEY = 'milan2026_market_v3';
    const ADMIN_PASSCODE = 'gold';

    /* ========================================
       2. STATE
       ======================================== */

    const DEFAULT_PORTFOLIOS = {
      1: ['ger', 'aut', 'swe', 'ned', 'jpn', 'nzl', 'bel'],           // Mike & Allegra Berry
      2: ['nor', 'can', 'chn', 'swe', 'bel', 'pol', 'nzl', 'lat'],    // Christopher & Rebecca Wray
      3: ['nor', 'ger', 'ita', 'aus', 'hun', 'pol', 'nzl', 'bel', 'est', 'lat'], // Stephen & Rhandi Zipp
      4: ['usa', 'ger', 'sui', 'ned', 'cze'],                          // Ryan & Haley Baskerville
      5: ['nor', 'ger', 'can', 'svn'],                                 // Maddi & Preston Lakey
      6: ['nor', 'can', 'ita', 'chn', 'aus', 'hun', 'bel']            // Jaynen & Britt Rissling
    };

    let appState = {
      portfolios: { ...DEFAULT_PORTFOLIOS },
      medalsLog: [],     // { id, countryId, eventDescription, medal, timestamp }
      marketOpen: false
    };

    let selectedMedalType = null;
    let sessionMedals = []; // tracks medals added in current admin session

    /* ========================================
       3. STATE MANAGEMENT
       ======================================== */

    function loadState() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          appState.medalsLog = parsed.medalsLog || [];
          appState.commentary = parsed.commentary || '';
          appState.commentaryTimestamp = parsed.commentaryTimestamp;
          appState.commentaryDay = parsed.commentaryDay;
          // Always use hard-coded portfolios
          appState.portfolios = { ...DEFAULT_PORTFOLIOS };
          appState.marketOpen = false;
        }
      } catch (e) {
        console.error('Failed to load state:', e);
        appState = { portfolios: { ...DEFAULT_PORTFOLIOS }, medalsLog: [], marketOpen: false, commentary: '' };
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
      } catch (e) {
        console.error('Failed to save state:', e);
      }
    }

    /* ========================================
       4. UTILITIES
       ======================================== */

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
    }

    function formatTimestamp(ts) {
      return new Date(ts).toLocaleDateString('en-US', {
        month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
      });
    }

    function getParticipantById(id) {
      return PARTICIPANTS.find(p => p.id === id);
    }

    /* ========================================
       5. SCORING
       ======================================== */

    function getMedalsForCountry(countryId) {
      return appState.medalsLog.filter(m => m.countryId === countryId);
    }

    function getPointsForCountry(countryId) {
      const medals = getMedalsForCountry(countryId);
      return medals.reduce((sum, m) => sum + MEDAL_POINTS[m.medal], 0);
    }

    function getMedalCountsForCountry(countryId) {
      const medals = getMedalsForCountry(countryId);
      return {
        gold: medals.filter(m => m.medal === 'gold').length,
        silver: medals.filter(m => m.medal === 'silver').length,
        bronze: medals.filter(m => m.medal === 'bronze').length
      };
    }

    function getScoresForParticipant(participantId) {
      const portfolio = appState.portfolios[participantId] || [];
      let total = 0, gold = 0, silver = 0, bronze = 0;

      portfolio.forEach(countryId => {
        total += getPointsForCountry(countryId);
        const counts = getMedalCountsForCountry(countryId);
        gold += counts.gold;
        silver += counts.silver;
        bronze += counts.bronze;
      });

      return { total, gold, silver, bronze };
    }

    function getLeaderboard() {
      return PARTICIPANTS.map(p => ({
        participant: p,
        portfolio: appState.portfolios[p.id] || [],
        scores: getScoresForParticipant(p.id)
      })).sort((a, b) => {
        if (b.scores.total !== a.scores.total) return b.scores.total - a.scores.total;
        return b.scores.gold - a.scores.gold;
      });
    }

    function getTotalLeaguePoints() {
      return PARTICIPANTS.reduce((sum, p) => sum + getScoresForParticipant(p.id).total, 0);
    }

    /* ========================================
       6. DASHBOARD
       ======================================== */

    function render() {
      renderDashboard();
    }

    function renderDashboard() {
      renderTotalPoints();
      renderLastUpdated();
      renderLeaderboard();
      renderCommentary();
      renderPortfolios();
    }

    function renderTotalPoints() {
      document.getElementById('total-medal-count').textContent = getTotalLeaguePoints();
    }

    function renderLastUpdated() {
      const el = document.getElementById('last-updated');
      if (appState.medalsLog.length === 0) {
        el.textContent = '';
        return;
      }
      const last = appState.medalsLog[appState.medalsLog.length - 1];
      el.textContent = `Updated ${formatTimestamp(last.timestamp)}`;
    }

    function renderLeaderboard() {
      const leaderboard = getLeaderboard();
      const container = document.getElementById('leaderboard-cards');

      container.innerHTML = leaderboard.map((entry, idx) => {
        const rank = idx + 1;
        const { participant, portfolio, scores } = entry;
        const countryFlags = portfolio.map(id => COUNTRIES[id].flag).join(' ');
        const totalMedals = scores.gold + scores.silver + scores.bronze;

        return `
          <div class="leaderboard-card rank-${rank <= 3 ? rank : 'other'}">
            <div class="rank-badge">${rank}</div>
            <div class="card-info">
              <div class="card-team-name">${participant.name}</div>
              <div class="card-portfolio-summary">${countryFlags || 'No portfolio'}</div>
            </div>
            <div class="card-stats">
              <div class="card-medals">
                <span style="color: var(--gold)">${scores.gold}G</span>
                <span style="color: var(--silver)">${scores.silver}S</span>
                <span style="color: var(--bronze)">${scores.bronze}B</span>
                <span style="color: var(--text-muted); font-size: 0.75rem">(${totalMedals})</span>
              </div>
              <div class="card-points">${scores.total}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderPortfolios() {
      const container = document.getElementById('portfolio-grid');

      container.innerHTML = PARTICIPANTS.map(p => {
        const portfolio = appState.portfolios[p.id] || [];
        const scores = getScoresForParticipant(p.id);
        const spent = portfolio.reduce((sum, id) => sum + COUNTRIES[id].price, 0);

        const countriesHtml = portfolio.length === 0
          ? '<p class="empty-state">No portfolio set</p>'
          : portfolio.map(id => {
              const c = COUNTRIES[id];
              const counts = getMedalCountsForCountry(id);
              const pts = getPointsForCountry(id);
              return `
                <div class="portfolio-country">
                  <a href="${c.olympicsUrl}" target="_blank" rel="noopener" class="portfolio-country-link" title="View ${c.name} on Olympics.com">
                    <span class="portfolio-country-flag">${c.flag}</span>
                    <span class="portfolio-country-name">${c.name} ($${c.price})</span>
                  </a>
                  <div class="portfolio-country-medals">
                    ${counts.gold ? `<span style="color:var(--gold)">${counts.gold}G</span>` : ''}
                    ${counts.silver ? `<span style="color:var(--silver)">${counts.silver}S</span>` : ''}
                    ${counts.bronze ? `<span style="color:var(--bronze)">${counts.bronze}B</span>` : ''}
                  </div>
                  <div class="portfolio-country-points">${pts}</div>
                </div>
              `;
            }).join('');

        return `
          <div class="portfolio-card">
            <div class="portfolio-card-header">
              <div class="portfolio-team-name">${p.name}</div>
              <div class="portfolio-stats">Spent: $${spent} | Points: ${scores.total}</div>
            </div>
            <div class="portfolio-card-body">
              ${countriesHtml}
            </div>
          </div>
        `;
      }).join('');
    }

    /* ========================================
       11. ADMIN
       ======================================== */

    function openAdmin() {
      const pass = prompt('Enter commissioner passcode:');
      if (pass !== ADMIN_PASSCODE) {
        if (pass !== null) showToast('Access denied', 'error');
        return;
      }
      sessionMedals = [];
      document.getElementById('admin-modal').classList.remove('hidden');
      renderAdminPanel();
      updateSessionBanner();
    }

    function closeAdmin() {
      document.getElementById('admin-modal').classList.add('hidden');
      resetAdminForm();

      // If medals were entered this session, trigger the daily update celebration
      if (sessionMedals.length > 0) {
        const medalsThisSession = [...sessionMedals];
        sessionMedals = [];

        renderDashboard();

        setTimeout(() => {
          showDailyRecapTicker(medalsThisSession);
        }, 200);

        setTimeout(() => {
          launchDailyCelebration(medalsThisSession);
        }, 800);
      }
    }

    function publishDailyUpdate() {
      // Also save commentary if written
      const input = document.getElementById('commentary-input');
      if (input && input.value.trim()) {
        saveCommentary();
      }
      closeAdmin();
    }

    function updateSessionBanner() {
      const banner = document.getElementById('session-banner');
      const text = document.getElementById('session-banner-text');
      const btn = document.getElementById('publish-update-btn');

      if (sessionMedals.length === 0) {
        banner.classList.add('hidden');
      } else {
        banner.classList.remove('hidden');
        const golds = sessionMedals.filter(m => m.medal === 'gold').length;
        const silvers = sessionMedals.filter(m => m.medal === 'silver').length;
        const bronzes = sessionMedals.filter(m => m.medal === 'bronze').length;
        const parts = [];
        if (golds) parts.push(`${golds}G`);
        if (silvers) parts.push(`${silvers}S`);
        if (bronzes) parts.push(`${bronzes}B`);
        text.textContent = `${sessionMedals.length} medal${sessionMedals.length !== 1 ? 's' : ''} added (${parts.join(' ')})`;
      }
    }

    function renderAdminPanel() {
      renderCountrySelect();
      renderTransactionLog();
      resetAdminForm();
      updateSessionBanner();
    }

    function renderCountrySelect() {
      const select = document.getElementById('country-select');
      const sorted = Object.values(COUNTRIES).sort((a, b) => a.name.localeCompare(b.name));
      select.innerHTML = `<option value="">-- Select country --</option>` +
        sorted.map(c => `<option value="${c.id}">${c.flag} ${c.name}</option>`).join('');
    }

    function renderTransactionLog() {
      const container = document.getElementById('transaction-log');
      if (appState.medalsLog.length === 0) {
        container.innerHTML = '<p class="empty-state">No medals recorded yet</p>';
        return;
      }

      const recent = [...appState.medalsLog].reverse().slice(0, 15);
      container.innerHTML = recent.map(entry => {
        const c = COUNTRIES[entry.countryId];
        return `
          <div class="transaction-item">
            <div class="transaction-info">
              <div class="transaction-main">${MEDAL_EMOJI[entry.medal]} ${c.flag} ${c.name} - ${entry.eventDescription}</div>
              <div class="transaction-time">${formatTimestamp(entry.timestamp)}</div>
            </div>
            <button class="transaction-delete" data-id="${entry.id}">‚úï</button>
          </div>
        `;
      }).join('');

      container.querySelectorAll('.transaction-delete').forEach(btn => {
        btn.addEventListener('click', () => removeMedal(btn.dataset.id));
      });
    }

    function resetAdminForm() {
      document.getElementById('country-select').value = '';
      document.getElementById('event-input').value = '';
      selectedMedalType = null;
      document.querySelectorAll('.medal-btn').forEach(b => b.classList.remove('selected'));
      updateAddMedalButton();
    }

    function updateAddMedalButton() {
      const country = document.getElementById('country-select').value;
      const event = document.getElementById('event-input').value.trim();
      document.getElementById('add-medal-btn').disabled = !country || !event || !selectedMedalType;
    }

    function addMedal() {
      const countryId = document.getElementById('country-select').value;
      const eventInput = document.getElementById('event-input');
      const eventDesc = eventInput.value.trim();
      if (!countryId || !eventDesc || !selectedMedalType) return;

      const c = COUNTRIES[countryId];
      const medalType = selectedMedalType;

      const entry = {
        id: generateId(),
        countryId,
        eventDescription: eventDesc,
        medal: medalType,
        timestamp: Date.now()
      };

      appState.medalsLog.push(entry);
      saveState();
      sessionMedals.push(entry);

      // Show inline flash confirmation (no confirm dialog for speed)
      showMedalFlash(medalType, c, eventDesc);

      // Only clear event field and medal selection -- keep country selected for rapid entry
      eventInput.value = '';
      selectedMedalType = null;
      document.querySelectorAll('.medal-btn').forEach(b => b.classList.remove('selected'));
      updateAddMedalButton();

      // Refresh log and session banner
      renderTransactionLog();
      updateSessionBanner();

      // Focus back on event input for next entry
      eventInput.focus();
    }

    function showMedalFlash(medalType, country, eventDesc) {
      // Remove any existing flash
      const existing = document.querySelector('.medal-added-flash');
      if (existing) existing.remove();

      const flash = document.createElement('div');
      flash.className = 'medal-added-flash';
      flash.textContent = `${MEDAL_EMOJI[medalType]} ${country.flag} ${country.name} ‚Äî ${eventDesc}`;

      const addBtn = document.getElementById('add-medal-btn');
      addBtn.parentNode.insertBefore(flash, addBtn);

      setTimeout(() => flash.remove(), 2500);
    }

    function removeMedal(medalId) {
      if (!confirm('Remove this medal?')) return;
      appState.medalsLog = appState.medalsLog.filter(m => m.id !== medalId);
      saveState();
      showToast('Medal removed', 'success');
      renderTransactionLog();
      renderDashboard();
    }

    function exportData() {
      navigator.clipboard.writeText(JSON.stringify(appState, null, 2));
      showToast('Data copied!', 'success');
    }

    function importData() {
      const json = prompt('Paste JSON:');
      if (!json) return;
      try {
        appState = JSON.parse(json);
        saveState();
        showToast('Imported!', 'success');
        closeAdmin();
        render();
      } catch (e) {
        showToast('Invalid JSON', 'error');
      }
    }

    function resetLeague() {
      if (!confirm('DELETE ALL DATA?')) return;
      if (prompt('Type RESET:') !== 'RESET') return;
      localStorage.removeItem(STORAGE_KEY);
      appState = { portfolios: { ...DEFAULT_PORTFOLIOS }, medalsLog: [], marketOpen: false, commentary: '' };
      closeAdmin();
      render();
    }

    /* ========================================
       12. TOAST
       ======================================== */

    function showToast(msg, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.className = `toast toast-${type}`;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    /* ========================================
       13. SNOWFALL
       ======================================== */

    function createSnowfall() {
      const container = document.getElementById('snowfall');
      const flakes = ['‚ùÑ', '‚ùÖ', '‚ùÜ', '‚ú¶', '‚úß'];
      for (let i = 0; i < 25; i++) {
        const s = document.createElement('span');
        s.className = 'snowflake';
        s.textContent = flakes[Math.floor(Math.random() * flakes.length)];
        s.style.left = Math.random() * 100 + '%';
        s.style.animationDuration = (Math.random() * 12 + 8) + 's';
        s.style.animationDelay = Math.random() * 8 + 's';
        s.style.fontSize = (Math.random() * 0.8 + 0.4) + 'rem';
        s.style.opacity = Math.random() * 0.5 + 0.2;
        container.appendChild(s);
      }
    }

    /* ========================================
       14C. EVENT SUGGESTIONS
       ======================================== */

    const EVENT_SUGGESTIONS = [
      "Men's Downhill Alpine Skiing",
      "Women's Downhill Alpine Skiing",
      "Men's Super-G Alpine Skiing",
      "Women's Super-G Alpine Skiing",
      "Men's Giant Slalom Alpine Skiing",
      "Women's Giant Slalom Alpine Skiing",
      "Men's Slalom Alpine Skiing",
      "Women's Slalom Alpine Skiing",
      "Men's Combined Alpine Skiing",
      "Women's Combined Alpine Skiing",
      "Mixed Team Parallel Alpine Skiing",
      "Men's 10km Sprint Biathlon",
      "Women's 7.5km Sprint Biathlon",
      "Men's 20km Individual Biathlon",
      "Women's 15km Individual Biathlon",
      "Men's 12.5km Pursuit Biathlon",
      "Women's 10km Pursuit Biathlon",
      "Men's 15km Mass Start Biathlon",
      "Women's 12.5km Mass Start Biathlon",
      "Men's 4x7.5km Relay Biathlon",
      "Women's 4x6km Relay Biathlon",
      "Mixed Relay Biathlon",
      "Two-Man Bobsled",
      "Four-Man Bobsled",
      "Two-Woman Bobsled",
      "Women's Monobob",
      "Men's Sprint Cross-Country Skiing",
      "Women's Sprint Cross-Country Skiing",
      "Men's Team Sprint Cross-Country Skiing",
      "Women's Team Sprint Cross-Country Skiing",
      "Men's 15km Classic Cross-Country Skiing",
      "Women's 10km Classic Cross-Country Skiing",
      "Men's Skiathlon Cross-Country Skiing",
      "Women's Skiathlon Cross-Country Skiing",
      "Men's 50km Mass Start Cross-Country Skiing",
      "Women's 30km Mass Start Cross-Country Skiing",
      "Men's 4x10km Relay Cross-Country Skiing",
      "Women's 4x5km Relay Cross-Country Skiing",
      "Men's Curling",
      "Women's Curling",
      "Mixed Doubles Curling",
      "Men's Singles Figure Skating",
      "Women's Singles Figure Skating",
      "Pairs Figure Skating",
      "Ice Dance Figure Skating",
      "Team Event Figure Skating",
      "Men's Moguls Freestyle Skiing",
      "Women's Moguls Freestyle Skiing",
      "Men's Aerials Freestyle Skiing",
      "Women's Aerials Freestyle Skiing",
      "Mixed Team Aerials Freestyle Skiing",
      "Men's Halfpipe Freestyle Skiing",
      "Women's Halfpipe Freestyle Skiing",
      "Men's Slopestyle Freestyle Skiing",
      "Women's Slopestyle Freestyle Skiing",
      "Men's Ski Cross Freestyle Skiing",
      "Women's Ski Cross Freestyle Skiing",
      "Men's Ice Hockey",
      "Women's Ice Hockey",
      "Men's Singles Luge",
      "Women's Singles Luge",
      "Doubles Luge",
      "Team Relay Luge",
      "Men's Normal Hill Ski Jumping",
      "Men's Large Hill Ski Jumping",
      "Women's Normal Hill Ski Jumping",
      "Men's Team Large Hill Ski Jumping",
      "Mixed Team Ski Jumping",
      "Men's Individual Gundersen NH/10km Nordic Combined",
      "Men's Individual Gundersen LH/10km Nordic Combined",
      "Men's Team Gundersen LH/4x5km Nordic Combined",
      "Men's 500m Short Track Speed Skating",
      "Women's 500m Short Track Speed Skating",
      "Men's 1000m Short Track Speed Skating",
      "Women's 1000m Short Track Speed Skating",
      "Men's 1500m Short Track Speed Skating",
      "Women's 1500m Short Track Speed Skating",
      "Men's 5000m Relay Short Track Speed Skating",
      "Women's 3000m Relay Short Track Speed Skating",
      "Mixed Team Relay Short Track Speed Skating",
      "Men's Skeleton",
      "Women's Skeleton",
      "Men's Sprint Ski Mountaineering",
      "Women's Sprint Ski Mountaineering",
      "Men's Individual Ski Mountaineering",
      "Women's Individual Ski Mountaineering",
      "Mixed Relay Ski Mountaineering",
      "Men's Big Air Snowboard",
      "Women's Big Air Snowboard",
      "Men's Halfpipe Snowboard",
      "Women's Halfpipe Snowboard",
      "Men's Slopestyle Snowboard",
      "Women's Slopestyle Snowboard",
      "Men's Snowboard Cross",
      "Women's Snowboard Cross",
      "Mixed Team Snowboard Cross",
      "Men's Parallel Giant Slalom Snowboard",
      "Women's Parallel Giant Slalom Snowboard",
      "Men's 500m Speed Skating",
      "Women's 500m Speed Skating",
      "Men's 1000m Speed Skating",
      "Women's 1000m Speed Skating",
      "Men's 1500m Speed Skating",
      "Women's 1500m Speed Skating",
      "Men's 5000m Speed Skating",
      "Women's 3000m Speed Skating",
      "Men's 10000m Speed Skating",
      "Women's 5000m Speed Skating",
      "Men's Mass Start Speed Skating",
      "Women's Mass Start Speed Skating",
      "Men's Team Pursuit Speed Skating",
      "Women's Team Pursuit Speed Skating"
    ];

    function populateEventSuggestions() {
      const datalist = document.getElementById('event-suggestions');
      if (!datalist) return;
      datalist.innerHTML = EVENT_SUGGESTIONS.map(e => `<option value="${e}">`).join('');
    }

    /* ========================================
       14E. MEDAL CELEBRATION & CONFETTI
       ======================================== */

    const MEDAL_COLORS = {
      gold: ['#FFD700', '#FFA500', '#FFE066', '#FFCC00', '#FFF8DC'],
      silver: ['#C0C0C0', '#E8E8E8', '#A9A9A9', '#D3D3D3', '#FFFFFF'],
      bronze: ['#CD7F32', '#E8A850', '#B87333', '#D4956A', '#8B4513']
    };

    function launchDailyCelebration(medals) {
      const overlay = document.getElementById('celebration-overlay');
      const canvas = document.getElementById('confetti-canvas');
      const medalEl = document.getElementById('celebration-medal');
      const textEl = document.getElementById('celebration-text');
      const eventEl = document.getElementById('celebration-event');

      // Compute summary
      const golds = medals.filter(m => m.medal === 'gold').length;
      const silvers = medals.filter(m => m.medal === 'silver').length;
      const bronzes = medals.filter(m => m.medal === 'bronze').length;
      const uniqueCountries = [...new Set(medals.map(m => m.countryId))];
      const flags = uniqueCountries.map(id => COUNTRIES[id].flag).join(' ');
      const day = getCompetitionDay();

      // Pick the "best" medal color for confetti (gold if any golds, etc.)
      const topMedal = golds > 0 ? 'gold' : silvers > 0 ? 'silver' : 'bronze';

      // Set content
      medalEl.textContent = `üèÖ ${medals.length}`;
      textEl.textContent = day ? `Day ${day} Results` : 'Daily Update';
      textEl.className = 'celebration-text gold-text';

      const parts = [];
      if (golds) parts.push(`ü•á${golds}`);
      if (silvers) parts.push(`ü•à${silvers}`);
      if (bronzes) parts.push(`ü•â${bronzes}`);
      eventEl.innerHTML = `${parts.join('  ')} across ${uniqueCountries.length} countries<br><span style="font-size:1.5rem;letter-spacing:0.15em;margin-top:8px;display:inline-block">${flags}</span>`;

      // Show overlay
      overlay.classList.remove('hidden');

      // Launch confetti with mixed colors
      const allColors = [...MEDAL_COLORS.gold, ...MEDAL_COLORS.silver, ...MEDAL_COLORS.bronze];
      launchConfetti(canvas, allColors);

      // Auto-dismiss after 5s (longer for summary), or click to dismiss
      const dismiss = () => {
        overlay.classList.add('hidden');
        overlay.removeEventListener('click', dismiss);
      };
      overlay.addEventListener('click', dismiss);
      setTimeout(dismiss, 5000);
    }

    function getCompetitionDay() {
      const gameStart = new Date('2026-02-06');
      const now = new Date();
      const diffDays = Math.floor((now - gameStart) / (1000 * 60 * 60 * 24)) + 1;
      return diffDays >= 1 && diffDays <= 17 ? diffDays : 0;
    }

    function launchConfetti(canvas, colors) {
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const particles = [];
      const PARTICLE_COUNT = 150;

      for (let i = 0; i < PARTICLE_COUNT; i++) {
        particles.push({
          x: canvas.width / 2 + (Math.random() - 0.5) * 200,
          y: canvas.height / 2,
          vx: (Math.random() - 0.5) * 20,
          vy: (Math.random() - 1) * 18 - 5,
          color: colors[Math.floor(Math.random() * colors.length)],
          size: Math.random() * 8 + 4,
          rotation: Math.random() * 360,
          rotationSpeed: (Math.random() - 0.5) * 15,
          gravity: 0.25 + Math.random() * 0.15,
          opacity: 1,
          shape: Math.random() > 0.5 ? 'rect' : 'circle'
        });
      }

      let frame = 0;
      const maxFrames = 120;

      function animate() {
        if (frame >= maxFrames) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          return;
        }
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        particles.forEach(p => {
          p.x += p.vx;
          p.vy += p.gravity;
          p.y += p.vy;
          p.vx *= 0.98;
          p.rotation += p.rotationSpeed;
          p.opacity = Math.max(0, 1 - (frame / maxFrames));

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate((p.rotation * Math.PI) / 180);
          ctx.globalAlpha = p.opacity;
          ctx.fillStyle = p.color;

          if (p.shape === 'rect') {
            ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * 0.6);
          } else {
            ctx.beginPath();
            ctx.arc(0, 0, p.size / 2, 0, Math.PI * 2);
            ctx.fill();
          }
          ctx.restore();
        });

        frame++;
        requestAnimationFrame(animate);
      }

      animate();
    }

    /* ========================================
       14F. BREAKING NEWS TICKER
       ======================================== */

    function showDailyRecapTicker(medals) {
      const ticker = document.getElementById('news-ticker');
      const text = document.getElementById('ticker-text');

      const golds = medals.filter(m => m.medal === 'gold').length;
      const silvers = medals.filter(m => m.medal === 'silver').length;
      const bronzes = medals.filter(m => m.medal === 'bronze').length;
      const uniqueCountries = [...new Set(medals.map(m => m.countryId))];
      const day = getCompetitionDay();

      const parts = [];
      if (golds) parts.push(`${golds} Gold`);
      if (silvers) parts.push(`${silvers} Silver`);
      if (bronzes) parts.push(`${bronzes} Bronze`);

      const dayLabel = day ? `Day ${day}` : 'Today';
      text.textContent = `${dayLabel}: ${medals.length} medals recorded ‚Äî ${parts.join(', ')} across ${uniqueCountries.length} countries. Leaderboard updated!`;

      ticker.classList.remove('hidden');

      // Reset animation
      text.style.animation = 'none';
      text.offsetHeight; // force reflow
      text.style.animation = '';

      setTimeout(() => {
        ticker.classList.add('hidden');
      }, 8000);
    }

    /* ========================================
       14H. COMMISSIONER COMMENTARY
       ======================================== */

    function saveCommentary() {
      const input = document.getElementById('commentary-input');
      const text = input.value.trim();
      if (!text) {
        showToast('Write something first!', 'error');
        return;
      }

      const day = getCompetitionDay();
      appState.commentary = text;
      appState.commentaryTimestamp = Date.now();
      appState.commentaryDay = day || null;
      saveState();

      showToast('Commentary published!', 'success');
      renderCommentary();
    }

    function renderCommentary() {
      const card = document.getElementById('commentary-card');
      const input = document.getElementById('commentary-input');

      if (appState.commentary) {
        const dayLabel = appState.commentaryDay ? `Day ${appState.commentaryDay}` : formatTimestamp(appState.commentaryTimestamp);
        card.innerHTML = `
          <div class="commentary-body">"${appState.commentary}"</div>
          <div class="commentary-sig">‚Äî Commissioner Reif-Wray, ${dayLabel}</div>
        `;
        // Pre-fill admin textarea with current commentary for editing
        if (input) input.value = appState.commentary;
      } else {
        card.innerHTML = '<p class="empty-state">No commentary yet. The Commissioner is sharpening his quill...</p>';
        if (input) {
          const day = getCompetitionDay();
          if (day) input.placeholder = `Day ${day}: The Norwegian Empire marches on! But watch out for the Swiss...`;
        }
      }
    }

    /* ========================================
       15. EVENT LISTENERS
       ======================================== */

    function initEventListeners() {
      // Admin
      document.getElementById('admin-key-btn').addEventListener('click', openAdmin);
      document.getElementById('close-modal-btn').addEventListener('click', closeAdmin);
      document.getElementById('modal-backdrop').addEventListener('click', closeAdmin);

      document.querySelectorAll('.medal-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.medal-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedMedalType = btn.dataset.medal;
          updateAddMedalButton();
        });
      });

      document.getElementById('country-select').addEventListener('change', updateAddMedalButton);
      document.getElementById('event-input').addEventListener('input', updateAddMedalButton);
      document.getElementById('add-medal-btn').addEventListener('click', addMedal);

      document.getElementById('publish-update-btn').addEventListener('click', publishDailyUpdate);
      document.getElementById('save-commentary-btn').addEventListener('click', saveCommentary);
      document.getElementById('export-btn').addEventListener('click', exportData);
      document.getElementById('import-btn').addEventListener('click', importData);
      document.getElementById('reset-btn').addEventListener('click', resetLeague);

      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') closeAdmin();
      });
    }

    /* ========================================
       15. INIT
       ======================================== */

    function init() {
      createSnowfall();
      loadState();
      initEventListeners();
      populateEventSuggestions();
      render();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
